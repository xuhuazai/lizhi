<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>李志播放器</title>
    <style>
        :root{
            --bg:#0f1724;
            --card:#0b1220;
            --accent:#ff6b6b;
            --muted:#9aa4b2;
            --glass: rgba(255,255,255,0.04);
        }
        *{box-sizing:border-box;margin:0;padding:0}
        html,body{
            height:100vh;
            margin:0;
            font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Helvetica Neue",Arial;
            font-size:16px;
            background: linear-gradient(180deg,#071026 0%, #071833 60%);
            color:#e6eef8;
            -webkit-font-smoothing:antialiased;
            overflow:hidden
        }
        .wrap{max-width:760px;margin:0 auto;padding:20px;width:100%;height:100vh;box-sizing:border-box;display:flex;align-items:center;justify-content:center}
        .player-card{background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02)); border-radius:16px; padding:16px; box-shadow:0 6px 30px rgba(2,6,23,0.6); display:flex; flex-direction:column; gap:12px; max-height:calc(100% - 40px); overflow:hidden; width:100%}
        .top{display:flex;gap:12px;align-items:center}
        .cover{width:84px;height:84px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#6b8cff);flex:0 0 84px;display:flex;align-items:center;justify-content:center;font-weight:700;color:rgba(255,255,255,0.95)}
        .meta{flex:1;min-width:0}
        .title{font-size:18px;font-weight:700;color:#fff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .artist{font-size:14px;color:var(--muted);margin-top:7px}

        .progress-wrap{padding:6px 0}
        .progress-bar{height:8px;background:var(--glass);border-radius:999px;position:relative;overflow:hidden;touch-action:none}
        .progress-buffer{position:absolute;left:0;top:0;height:100%;background:rgba(255,255,255,0.06);width:0}
        .progress-fill{position:absolute;left:0;top:0;height:100%;background:linear-gradient(90deg,var(--accent),#6b8cff);width:0}
        .time{display:flex;justify-content:space-between;font-size:13px;color:var(--muted);margin-top:8px}

        .controls{display:flex;gap:20px;align-items:center;justify-content:center;padding:8px}
        .btn{
            background:transparent;
            border:none;
            color:inherit;
            display:inline-flex;
            align-items:center;
            justify-content:center;
            cursor:pointer;
            font-size:18px;
        }
        .big-btn{
            width:64px;
            height:64px;
            border-radius:50%;
            background:linear-gradient(180deg,rgba(255,255,255,0.06), rgba(255,255,255,0.03));
            box-shadow:0 6px 18px rgba(11,20,32,0.6);
            font-size:24px;
        }

        .search-box{margin-top:6px}
        .search-input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;font-size:14px}

        .playlist{overflow:auto;margin-top:8px;border-radius:8px;padding:8px;background:transparent;flex:1;min-height:0}
        .song-item{padding:12px 14px;border-radius:9px;color:var(--muted);font-size:15px;display:flex;justify-content:space-between;align-items:center;gap:10px}
        .song-item + .song-item{margin-top:6px}
        .song-item.active{background:linear-gradient(90deg, rgba(255,107,107,0.08), rgba(107,140,255,0.06));color:#fff}
        .no-result{Padding:12px;text-align:center;color:var(--muted);font-size:15px}

        @media(min-width:720px){.wrap{padding:24px}.player-card{padding:20px}}
        @media(max-width:420px){
            html,body{font-size:17px;}
            .wrap{padding:12px; margin:8px auto; width:calc(100% - 16px)}
            .player-card{max-height:calc(100vh - 16px);padding:12px}
            .cover{width:70px;height:70px}
            .big-btn{width:54px;height:54px;font-size:22px}
            /* 在移动设备上放大上一首/下一首按钮，增大触控目标 */
            .controls .btn:not(.big-btn){
                width:48px;
                height:48px;
                border-radius:50%;
                background:linear-gradient(180deg,rgba(255,255,255,0.04), rgba(255,255,255,0.02));
                box-shadow:0 6px 18px rgba(11,20,32,0.6);
                display:inline-flex;
                align-items:center;
                justify-content:center;
                font-size:16px;
            }
            .controls .btn svg{width:20px;height:20px}
            .playlist{max-height:none;flex:1;min-height:0}
        }
        /* 大屏 / 车机优化：进一步放大控件和封面，增加触控目标 */
        @media(min-width:900px){
            html,body{font-size:18px;}
            .big-btn{width:80px;height:80px;font-size:28px}
            .controls .btn:not(.big-btn){width:64px;height:64px;border-radius:50%;font-size:20px}
            .cover{width:110px;height:110px;flex:0 0 110px}
            .controls .btn svg{width:28px;height:28px}
            .title{font-size:22px;}
            .artist{font-size:16px;}
            .song-item{font-size:17px;}
        }
    </style>
    <link rel="icon" sizes="any" mask href="./static/images/favicon.ico">
    <link rel="shortcut icon" href="./static/images/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="./static/images/apple-touch-icon.png" />
    <!-- MediaElement (播放库) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mediaelement@5.0.4/build/mediaelementplayer.min.css" />
</head>
<body>
    <!-- 原生 audio 元素，MediaElement 将基于此元素工作 -->
    <audio id="audioElem" preload="auto" crossorigin="anonymous"></audio>
    <script src="https://cdn.jsdelivr.net/npm/mediaelement@5.0.4/build/mediaelement-and-player.min.js"></script>
    <div class="wrap">
        <div class="player-card">
            <div class="top">
                <div class="cover" id="cover">歌</div>
                <div class="meta">
                    <div class="title" id="songTitle">未播放歌曲</div>
                    <div class="artist" id="artist">未知艺术家</div>
                </div>
            </div>

            <div class="progress-wrap">
                <div class="progress-bar" id="progressBar">
                    <div class="progress-buffer" id="progressBuffer"></div>
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="time"><span id="currentTime">00:00</span><span id="totalTime">00:00</span></div>
            </div>

            <div class="controls">
                <button class="btn" id="prevBtn" aria-label="上一首">
                    <!-- previous icon -->
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                        <path d="M6 6h2v12H6V6zm3.5 6l8.5 6V6l-8.5 6z" fill="currentColor"/>
                    </svg>
                </button>
                <button class="btn big-btn" id="playBtn" aria-label="播放/暂停">▶</button>
                <button class="btn" id="nextBtn" aria-label="下一首">
                    <!-- next icon -->
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                        <path d="M6 6l8.5 6-8.5 6V6zm11 0h2v12h-2V6z" fill="currentColor"/>
                    </svg>
                </button>
            </div>

            <div class="search-box"><input id="searchInput" class="search-input" placeholder="搜索歌曲..."/></div>

            <div class="playlist" id="playlist">
                <div class="song-item">加载中...</div>
            </div>
        </div>
    </div>

    <script>
        const audio = document.getElementById('audioElem');
        let mediaPlayer = null;
        const playBtn = document.getElementById('playBtn');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const progressBar = document.getElementById('progressBar');
        const progressBuffer = document.getElementById('progressBuffer');
        const progressFill = document.getElementById('progressFill');
        const currentTimeEl = document.getElementById('currentTime');
        const totalTimeEl = document.getElementById('totalTime');
        const songTitleEl = document.getElementById('songTitle');
        const playlistEl = document.getElementById('playlist');
        const searchInput = document.getElementById('searchInput');
        const coverEl = document.getElementById('cover');
        const artistEl = document.getElementById('artist');
        const originalTitle = document.title;

        let songList = [];
        let filteredList = [];
        let currentIndex = 0;
        let isPlaying = false;
        let bufferTimer = null;
        // debug 开关：仅在 URL 包含 ?debug=1 时为 true
        const DEBUG = (new URLSearchParams(location.search)).get('debug') === '1';
        // 调试面板折叠状态存储键
        const COLLAPSED_KEY = 'lizhi_dbg_panel_collapsed_v1';
        function isPanelCollapsed(){ try{ return localStorage.getItem(COLLAPSED_KEY) === '1'; }catch(e){ return false; } }
        function setPanelCollapsed(v){ try{ localStorage.setItem(COLLAPSED_KEY, v ? '1' : '0'); }catch(e){} }
        // 收藏功能
        const FAVORITES_KEY = 'lizhi_favorites_v1';
        let favorites = [];
        function loadFavorites(){
            try{
                const raw = localStorage.getItem(FAVORITES_KEY);
                favorites = raw ? JSON.parse(raw) : [];
            }catch(e){ favorites = []; }
        }
        function saveFavorites(){
            try{ localStorage.setItem(FAVORITES_KEY, JSON.stringify(favorites || [])); }catch(e){}
        }
        function isFavorite(url){ return favorites.indexOf(url) !== -1; }
        function toggleFavorite(url){
            if (!url) return;
            const i = favorites.indexOf(url);
            if (i === -1) favorites.unshift(url);
            else favorites.splice(i,1);
            saveFavorites();
            renderPlaylist();
            renderStatusPanel();
        }

        // -----------------------------
        // 事件日志与调试面板（仅 DEBUG 时启用）
        // -----------------------------
        const EVENT_LOG_KEY = '__player_event_log';
        const MAX_EVENT_LOG = 200;

        function readEventLog(){
            if (!DEBUG) return [];
            try{ return JSON.parse(sessionStorage.getItem(EVENT_LOG_KEY) || '[]'); }catch(e){ return []; }
        }
        function writeEventLog(log){ if (!DEBUG) return; try{ sessionStorage.setItem(EVENT_LOG_KEY, JSON.stringify(log.slice(-MAX_EVENT_LOG))); }catch(e){} }

        function pushLog(name, detail){
            if (!DEBUG) return;
            const log = readEventLog();
            const entry = { t: new Date().toISOString(), name, detail: detail || null, visibility: document.visibilityState, audioPaused: !!audio.paused, src: audio.src || null };
            log.push(entry);
            writeEventLog(log);
            // 更新 UI
            renderStatusPanel();
            // also console
            console.log('[PLAYER-LOG]', entry);
        }

        // 外部也可推送日志
        try{ window.__player_push_log = pushLog; }catch(e){}

        // 快捷导出调试日志
        function exportEventLog(){
            const log = readEventLog();
            const blob = new Blob([JSON.stringify(log, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `lizhi-player-log-${(new Date()).toISOString()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // 绑定常见事件到日志
        if (DEBUG) {
            document.addEventListener('visibilitychange', ()=> pushLog('visibilitychange'));
            window.addEventListener('focus', ()=> pushLog('focus'));
            window.addEventListener('blur', ()=> pushLog('blur'));
            window.addEventListener('pageshow', (e)=> pushLog('pageshow', e && e.persisted ? 'bfcache:restored' : 'normal'));
            window.addEventListener('pagehide', (e)=> pushLog('pagehide', e && e.persisted ? 'bfcache:stored' : 'normal'));
            window.addEventListener('beforeunload', ()=> pushLog('beforeunload'));
            window.addEventListener('unload', ()=> pushLog('unload'));
            window.addEventListener('hashchange', ()=> pushLog('hashchange'));
            window.addEventListener('popstate', ()=> pushLog('popstate'));
            window.addEventListener('storage', (e)=> pushLog('storage', `${e.key} changed`));
        }

        // DEBUG: 拦截 fetch 以记录网络请求（仅在 debug 模式）
        if (DEBUG && window.fetch) {
            const __orig_fetch = window.fetch.bind(window);
            window.fetch = async function(...args){
                const url = args[0] && String(args[0]);
                const start = Date.now();
                pushLog('fetch.start', url);
                try{
                    const res = await __orig_fetch(...args);
                    const time = Date.now() - start;
                    pushLog('fetch.end', `${url} status:${res.status} time:${time}ms`);
                    return res;
                }catch(err){
                    const time = Date.now() - start;
                    pushLog('fetch.error', `${url} err:${err && err.message} time:${time}ms`);
                    throw err;
                }
            };
        }
        // 初始化 MediaElementPlayer（如果库已加载）
        try{
            if (window.MediaElementPlayer && audio) {
                mediaPlayer = new MediaElementPlayer(audio, {
                    features: [],
                    // 不显示默认控件，保持页面自定义控件
                    success: function(mediaElement, originalNode) {
                        try{ if (DEBUG) pushLog('mediaelement.init', navigator.userAgent); }catch(e){}
                    }
                });
            }
        }catch(e){
            console.warn('mediaelement init failed', e);
            try{ if (DEBUG) pushLog('mediaelement.init_error', String(e)); }catch(_){ }
        }
        // 加载与重试控制，防止网络差导致卡死
        const LOAD_TIMEOUT_MS = 15000; // 超时阈值
        const MAX_RETRIES = 2; // 每首歌最大重试次数
        let loadTimeout = null;
        const retryCounts = {}; // key: song url or index -> count

        async function loadSongs() {
            try {
                const res = await fetch('https://cdn.jsdelivr.net/gh/nj-lizhi/song/audio/download.txt');
                if (!res.ok) throw new Error('加载失败');

                const text = await res.text();
                songList = text.split('\n')
                    .filter(line => line.trim() && (line.endsWith('.mp3') || line.endsWith('.flac')))
                    .map(url => {
                        const newUrl = url.replace('testingcf.jsdelivr.net', 'cdn.jsdmirror.com');
                        const fileName = newUrl.split('/').pop();
                        const title = fileName.substring(0, fileName.lastIndexOf('.'));
                        return { title, url: newUrl };
                    });

                filteredList = [...songList];
                renderPlaylist();
                initSearch();
                pushLog('songs.loaded', `count:${songList.length}`);
            } catch (err) {
                playlistEl.innerHTML = `<div class="song-item">${err.message}</div>`;
                pushLog('songs.load_error', err.message);
            }
        }

        function renderPlaylist() {
            playlistEl.innerHTML = '';
            if (filteredList.length === 0) {
                const noResult = document.createElement('div');
                noResult.className = 'no-result';
                noResult.textContent = '未找到匹配歌曲';
                playlistEl.appendChild(noResult);
                return;
            }

            // 将收藏的歌曲排到前面（并保持其它排序）
            const favs = [];
            const others = [];
            filteredList.forEach(s => { if (isFavorite(s.url)) favs.push(s); else others.push(s); });
            const displayList = [...favs, ...others];

            displayList.forEach((song) => {
                const originalIndex = songList.findIndex(item => item.url === song.url);
                const item = document.createElement('div');
                item.className = 'song-item';
                item.dataset.index = originalIndex;

                const left = document.createElement('div');
                left.style.display = 'flex';
                left.style.alignItems = 'center';
                left.style.gap = '8px';

                const favBtn = document.createElement('button');
                favBtn.className = 'btn';
                favBtn.style.fontSize = '20px';
                favBtn.style.width = '28px';
                favBtn.style.height = '28px';
                favBtn.style.padding = '0';
                favBtn.style.lineHeight = '1';
                favBtn.style.userSelect = 'none';
                favBtn.textContent = isFavorite(song.url) ? '★' : '☆';
                favBtn.title = '长按收藏/取消收藏';
                // 阻止长按弹出原生菜单
                favBtn.addEventListener('pointerdown', e => { e.preventDefault(); });
                favBtn.addEventListener('touchstart', e => { e.preventDefault(); });
                // 为减少误触：改为长按（600ms）确认收藏/取消；单击仅提示
                (function(btn, s){
                    let pressTimer = null;
                    const LONGPRESS_MS = 600;
                    function clearPress(){ if (pressTimer) { clearTimeout(pressTimer); pressTimer = null; } }
                    btn.addEventListener('pointerdown', (ev) => {
                        ev.stopPropagation();
                        // start longpress timer
                        pressTimer = setTimeout(()=>{
                            toggleFavorite(s.url);
                            try{ pushLog('favorite.longpress', s.url); }catch(e){}
                            pressTimer = null;
                        }, LONGPRESS_MS);
                    });
                    btn.addEventListener('pointerup', (ev) => {
                        ev.stopPropagation();
                        if (pressTimer) {
                            // short tap -> notify user to long-press
                            clearPress();
                            showToast('长按以收藏/取消收藏');
                        }
                    });
                    btn.addEventListener('pointercancel', ()=>{ clearPress(); });
                })(favBtn, song);

                const titleSpan = document.createElement('span');
                titleSpan.textContent = song.title;

                left.appendChild(favBtn);
                left.appendChild(titleSpan);

                item.appendChild(left);

                item.onclick = () => {
                    currentIndex = originalIndex;
                    isPlaying = true;
                    playSong();
                    scrollToActiveSong();
                };

                playlistEl.appendChild(item);
            });

            updatePlaylistActive();
        }

        function handleLoadFailure(reason) {
            pushLog('load.failure', reason);
            renderStatusPanel();
            const key = String(currentIndex);
            retryCounts[key] = (retryCounts[key] || 0) + 1;
            const attempts = retryCounts[key];
            console.log('[PLAYER] load failure', reason, 'attempts', attempts);
            try { if (window.__player_push_log) window.__player_push_log('load.failure', `${reason} attempts:${attempts}`); } catch(e){}

            if (attempts <= MAX_RETRIES) {
                // 重试：短延迟后重新调用 playSong
                setTimeout(() => {
                    pushLog('retry', `index:${currentIndex} attempt:${attempts}`);
                    // 重新加载当前曲目
                    playSong();
                }, 800 + attempts * 300);
            } else {
                // 达到最大重试，跳到下一首并清理计时器
                console.log('[PLAYER] skip to next after failures');
                pushLog('skip.to.next', `from:${key}`);
                retryCounts[key] = 0;
                currentIndex = (currentIndex + 1) % songList.length;
                isPlaying = true;
                playSong();
                scrollToActiveSong();
            }
        }

        function updatePlaylistActive() {
            document.querySelectorAll('.song-item').forEach(item => {
                if (Number(item.dataset.index) === currentIndex) item.classList.add('active');
                else item.classList.remove('active');
            });
        }

        function initSearch() {
            searchInput.addEventListener('input', (e) => {
                const keyword = e.target.value.trim().toLowerCase();
                filteredList = songList.filter(song => song.title.toLowerCase().includes(keyword));
                renderPlaylist();
            });
        }

        // 状态面板与 MediaSession 支持
        let lastAudioError = null;
        function renderStatusPanel(){
            if (!DEBUG) return;
            let panel = document.getElementById('__player_ms_status');
            if(!panel){
                panel = document.createElement('div');
                panel.id = '__player_ms_status';
                panel.style.position = 'fixed';
                panel.style.right = '8px';
                panel.style.bottom = '8px';
                panel.style.background = 'rgba(0,0,0,0.6)';
                panel.style.color = '#fff';
                panel.style.fontSize = '12px';
                panel.style.padding = '8px';
                panel.style.borderRadius = '8px';
                panel.style.zIndex = 99999;
                panel.style.maxWidth = '320px';
                document.body.appendChild(panel);
            }
            const msSupported = !!navigator.mediaSession;
            const msState = (navigator.mediaSession && navigator.mediaSession.playbackState) || '-';
            const attempts = retryCounts[String(currentIndex)] || 0;
            const events = readEventLog().slice(-20).reverse();
            const collapsed = isPanelCollapsed();

            if (collapsed) {
                // Collapsed view: a small toggle button
                panel.style.maxWidth = '120px';
                panel.style.padding = '6px';
                panel.innerHTML = `<div style="display:flex;align-items:center;gap:8px"><button id="__dbg_toggle" style="font-size:14px;padding:4px 8px">▶ 调试</button><div style="font-size:11px;color:#9aa4b2">${msSupported ? 'MS:✓' : 'MS:✗'}</div></div>`;
                const tog = panel.querySelector('#__dbg_toggle');
                if (tog) tog.onclick = ()=>{ setPanelCollapsed(false); renderStatusPanel(); pushLog('panel.expand'); };
                return;
            }

            // Expanded view
            panel.style.maxWidth = '420px';
            panel.style.padding = '8px';
            let html = '';
            html += `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><div><strong>MediaSession:</strong> ${msSupported ? '支持' : '不支持'} &nbsp; <strong>state:</strong> ${msState}</div><div><button id="__dbg_toggle" style="font-size:12px;padding:2px 6px">收起</button></div></div>`;
            html += `<div style="margin-bottom:6px"><strong>song:</strong> ${songList[currentIndex]?songList[currentIndex].title:'-'} &nbsp; <strong>retries:</strong> ${attempts}</div>`;
            html += `<div style="margin-bottom:6px;color:#f88"><strong>lastErr:</strong> ${lastAudioError? lastAudioError : '-'}</div>`;
            html += `<div style="margin:6px 0"><button id="__dbg_export" style="margin-right:6px">导出日志</button><button id="__dbg_clear">清除日志</button></div>`;
            html += `<div style="max-height:160px;overflow:auto;border-top:1px solid rgba(255,255,255,0.04);padding-top:6px">`;
            if (events.length === 0) html += '<div style="color:#9aa4b2">(无事件)</div>';
            else events.forEach(ev => {
                html += `<div style="padding:4px 0;border-bottom:1px solid rgba(255,255,255,0.02)"><div style="font-weight:600">${ev.t} — ${ev.name}</div><div style="color:#9aa4b2;font-size:11px">${ev.detail||''} vis:${ev.visibility} paused:${ev.audioPaused} src:${ev.src?decodeURIComponent(ev.src.split('/').pop()):'-'}</div></div>`;
            });
            html += `</div>`;
            panel.innerHTML = html;

            const tog = panel.querySelector('#__dbg_toggle');
            const exp = panel.querySelector('#__dbg_export');
            const clr = panel.querySelector('#__dbg_clear');
            if (tog) tog.onclick = ()=>{ setPanelCollapsed(true); renderStatusPanel(); pushLog('panel.collapse'); };
            if (exp) exp.onclick = exportEventLog;
            if (clr) clr.onclick = ()=>{ sessionStorage.removeItem(EVENT_LOG_KEY); renderStatusPanel(); };
        }

        function setupMediaSession(song){
            if (!('mediaSession' in navigator)) return;
            try{
                navigator.mediaSession.metadata = new MediaMetadata({
                    title: song.title || '',
                    artist: '李志',
                    album: '',
                    artwork: [
                        // fallback tiny SVG as artwork to increase chance of being registered
                        { src: 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="300" height="300"><rect width="100%" height="100%" fill="#6b8cff"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-size="40" fill="#fff">${(song.title||'歌').slice(0,2).toUpperCase()}</text></svg>`), sizes: '300x300', type: 'image/svg+xml' }
                    ]
                });

                navigator.mediaSession.playbackState = isPlaying ? 'playing' : 'paused';

                navigator.mediaSession.setActionHandler('play', ()=>{ audio.play().catch(()=>{}); navigator.mediaSession.playbackState = 'playing'; });
                navigator.mediaSession.setActionHandler('pause', ()=>{ audio.pause(); navigator.mediaSession.playbackState = 'paused'; });
                navigator.mediaSession.setActionHandler('previoustrack', ()=>{ prevBtn.click(); });
                navigator.mediaSession.setActionHandler('nexttrack', ()=>{ nextBtn.click(); });
            }catch(e){
                console.warn('setupMediaSession failed', e);
            }
            renderStatusPanel();
        }

        // 简单吐司提示（短时间显示）
        function showToast(msg){
            try{
                let t = document.getElementById('__lizhi_toast');
                if (!t) {
                    t = document.createElement('div');
                    t.id = '__lizhi_toast';
                    t.style.position = 'fixed';
                    t.style.left = '50%';
                    t.style.bottom = '20px';
                    t.style.transform = 'translateX(-50%)';
                    t.style.background = 'rgba(0,0,0,0.7)';
                    t.style.color = '#fff';
                    t.style.padding = '8px 12px';
                    t.style.borderRadius = '8px';
                    t.style.zIndex = 999999;
                    t.style.transition = 'opacity 220ms ease';
                    t.style.opacity = '0';
                    document.body.appendChild(t);
                }
                t.textContent = msg;
                t.style.opacity = '1';
                if (t._timeout) clearTimeout(t._timeout);
                t._timeout = setTimeout(()=>{ t.style.opacity = '0'; }, 1300);
            }catch(e){ console.warn('toast failed', e); }
        }

        let nextScheduled = false;
        function playNext(reason){
            try{ pushLog('play.next.request', reason || 'auto'); }catch(e){}
            if (!songList.length) return;
            currentIndex = (currentIndex + 1) % songList.length;
            isPlaying = true;
            nextScheduled = false;
            // ensure retryCounts reset for new track
            try{ retryCounts[String(currentIndex)] = retryCounts[String(currentIndex)] || 0; }catch(e){}
            playSong();
            scrollToActiveSong();
        }

        function playSong() {
            if (!songList.length) return;
            const song = songList[currentIndex];
            audio.pause();
            audio.preload = 'auto';
            // 清理上一次的超时
            try{ if (loadTimeout) { clearTimeout(loadTimeout); loadTimeout = null; } }catch(e){}
            audio.src = song.url;
            // Some platforms (iOS) are more reliable if load() is explicitly called
            try{ audio.load(); }catch(e){}
            pushLog('song.select', song.title);
            pushLog('audio.src_set', song.url);
            songTitleEl.textContent = song.title;
            artistEl.textContent = '李志';
            // cover: show first 2 chars as fallback
            coverEl.textContent = song.title.slice(0,2).toUpperCase();
            document.title = `${song.title} | ${originalTitle}`;

            updatePlaylistActive();
            // 更新 MediaSession metadata / handlers（如浏览器/车机支持）
            try{ setupMediaSession(song); }catch(e){}
            renderStatusPanel();
            // 设置加载超时，避免在网络极差时永远卡住
            loadTimeout = setTimeout(()=>{
                loadTimeout = null;
                handleLoadFailure('load_timeout');
            }, LOAD_TIMEOUT_MS);

            audio.onloadedmetadata = () => {
                // metadata 可用时清理加载超时
                try{ if (loadTimeout) { clearTimeout(loadTimeout); loadTimeout = null; } }catch(e){}
                // update buffered UI once metadata is available
                updateBuffer();
                if (bufferTimer) clearInterval(bufferTimer);
                bufferTimer = setInterval(updateBuffer, 700);
                // 尝试播放，若被阻止则视为加载失败
                audio.play().then(() => {
                    isPlaying = true;
                    playBtn.textContent = '❚❚';
                    nextScheduled = false;
                }).catch((err) => {
                    console.log('[PLAYER] play rejected onloadedmetadata', err);
                    isPlaying = false;
                    playBtn.textContent = '▶';
                    handleLoadFailure('play_rejected');
                });
            };
        }

        playBtn.onclick = () => {
            if (!songList.length) {
                loadSongs().then(() => {
                    if (songList.length) {
                        isPlaying = true;
                        playSong();
                    }
                });
                return;
            }

            // 如果还没有设置 src（即 audio.src 为空），自动选中排序后显示的第一首（displayList[0]）并 playSong
            if (!audio.src || audio.src === location.href) {
                // 生成与 renderPlaylist 一致的 displayList
                const favs = [], others = [];
                filteredList.forEach(s => { if (isFavorite(s.url)) favs.push(s); else others.push(s); });
                const displayList = [...favs, ...others];
                if (displayList.length > 0) {
                    const idx = songList.findIndex(s => s.url === displayList[0].url);
                    if (idx !== -1) currentIndex = idx;
                    else currentIndex = 0;
                } else {
                    currentIndex = 0;
                }
                isPlaying = true;
                playSong();
                return;
            }

            if (isPlaying) {
                audio.pause();
                playBtn.textContent = '▶';
            } else {
                audio.play().then(()=>{
                    playBtn.textContent = '❚❚';
                }).catch(()=>{
                    playBtn.textContent = '▶';
                });
            }
            isPlaying = !isPlaying;
            try{ if ('mediaSession' in navigator) navigator.mediaSession.playbackState = isPlaying ? 'playing' : 'paused'; }catch(e){}
            renderStatusPanel();
        };

        function getDisplayList() {
            const favs = [], others = [];
            filteredList.forEach(s => { if (isFavorite(s.url)) favs.push(s); else others.push(s); });
            return [...favs, ...others];
        }

        prevBtn.onclick = () => {
            const displayList = getDisplayList();
            if (!displayList.length) return;
            // 找到当前 currentIndex 在 displayList 的位置
            let curIdx = displayList.findIndex(s => songList[currentIndex] && s.url === songList[currentIndex].url);
            if (curIdx === -1) curIdx = 0;
            let prevIdx = (curIdx - 1 + displayList.length) % displayList.length;
            // 找到 displayList[prevIdx] 在 songList 的索引
            const idx = songList.findIndex(s => s.url === displayList[prevIdx].url);
            if (idx !== -1) currentIndex = idx;
            else currentIndex = 0;
            isPlaying = true;
            playSong();
            scrollToActiveSong();
        };

        nextBtn.onclick = () => {
            const displayList = getDisplayList();
            if (!displayList.length) return;
            let curIdx = displayList.findIndex(s => songList[currentIndex] && s.url === songList[currentIndex].url);
            if (curIdx === -1) curIdx = 0;
            let nextIdx = (curIdx + 1) % displayList.length;
            const idx = songList.findIndex(s => s.url === displayList[nextIdx].url);
            if (idx !== -1) currentIndex = idx;
            else currentIndex = 0;
            isPlaying = true;
            playSong();
            scrollToActiveSong();
        };

        function scrollToActiveSong() {
            const activeItem = document.querySelector('.song-item.active');
            if (activeItem) activeItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        audio.ontimeupdate = () => {
            if (isNaN(audio.duration)) return;
            const progress = (audio.currentTime / audio.duration) * 100;
            progressFill.style.width = `${progress}%`;
            currentTimeEl.textContent = formatTime(audio.currentTime);
            totalTimeEl.textContent = formatTime(audio.duration);
            // 如果接近结束（比如剩余 < 0.8s），在锁屏或特殊环境下 ended 可能不可靠
            try{
                const remain = audio.duration - audio.currentTime;
                if (remain <= 0.8 && !nextScheduled && audio.duration > 0 && isPlaying) {
                    nextScheduled = true;
                    // schedule immediate next track attempt
                    setTimeout(()=>{
                        // double-check we're still near end
                        if (audio.duration - audio.currentTime <= 1.2) {
                            playNext('near_end');
                        } else {
                            nextScheduled = false;
                        }
                    }, 300);
                }
            }catch(e){}
        };

        // update buffered progress using audio.buffered ranges
        function updateBuffer(){
            try{
                if (isNaN(audio.duration) || !audio.buffered) {
                    progressBuffer.style.width = `0%`;
                    return;
                }
                // find the last buffered range that starts at or before currentTime
                let bufferedEnd = 0;
                for (let i=0;i<audio.buffered.length;i++){
                    bufferedEnd = Math.max(bufferedEnd, audio.buffered.end(i));
                }
                const bufPercent = Math.min(100, (bufferedEnd / audio.duration) * 100);
                progressBuffer.style.width = `${bufPercent}%`;
            }catch(e){
                // ignore
            }
        }

        audio.addEventListener('progress', updateBuffer);
        audio.addEventListener('waiting', ()=>{
            // network stall - show buffering indicator
            playBtn.textContent = '⏳';
        });
        audio.addEventListener('stalled', ()=>{
            playBtn.textContent = '⏳';
        });
        audio.addEventListener('playing', ()=>{
            // restore play icon when actually playing
            if (isPlaying) playBtn.textContent = '❚❚';
            updateBuffer();
            try{ if ('mediaSession' in navigator) navigator.mediaSession.playbackState = 'playing'; }catch(e){}
            renderStatusPanel();
        });
        audio.addEventListener('pause', ()=>{
            try{ if ('mediaSession' in navigator) navigator.mediaSession.playbackState = 'paused'; }catch(e){}
            renderStatusPanel();
        });
        audio.addEventListener('ended', ()=>{
            try{ if ('mediaSession' in navigator) navigator.mediaSession.playbackState = 'none'; }catch(e){}
            renderStatusPanel();
        });
        audio.addEventListener('canplay', ()=>{
            updateBuffer();
        });
        // 当可以完整播放到足够缓冲时清理超时并尝试恢复播放
        audio.addEventListener('canplaythrough', ()=>{
            try{ if (loadTimeout) { clearTimeout(loadTimeout); loadTimeout = null; } }catch(e){}
            if (isPlaying) {
                audio.play().catch(()=>{});
            }
        });

        audio.addEventListener('error', (ev)=>{
            console.log('[PLAYER] audio.error', ev);
            lastAudioError = (ev && ev.message) ? ev.message : JSON.stringify(ev);
            renderStatusPanel();
            handleLoadFailure('audio_error');
        });
        // clear interval on unload
        window.addEventListener('beforeunload', ()=>{ if (bufferTimer) clearInterval(bufferTimer); });

        // Pointer-based seek for better mobile support
        let dragging = false;
        function seekFromClientX(clientX){
            const rect = progressBar.getBoundingClientRect();
            let pos = (clientX - rect.left) / rect.width;
            pos = Math.max(0, Math.min(1, pos));
            if (!isNaN(audio.duration)) audio.currentTime = pos * audio.duration;
        }

        progressBar.addEventListener('pointerdown', (e) => {
            dragging = true;
            progressBar.setPointerCapture(e.pointerId);
            seekFromClientX(e.clientX);
        });
        progressBar.addEventListener('pointermove', (e) => {
            if (!dragging) return;
            seekFromClientX(e.clientX);
        });
        progressBar.addEventListener('pointerup', (e) => {
            dragging = false;
            try { progressBar.releasePointerCapture(e.pointerId); } catch(_){}
        });

        function formatTime(sec) {
            const m = Math.floor(sec / 60).toString().padStart(2, '0');
            const s = Math.floor(sec % 60).toString().padStart(2, '0');
            return `${m}:${s}`;
        }

        audio.onended = () => nextBtn.click();

        // 初始化加载歌曲列表
        // 加载本地收藏与歌曲列表
        loadFavorites();
        loadSongs();
    </script>
</body>
</html>
