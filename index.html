<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>李志播放器</title>
    <style>
        :root{
            --bg:#0f1724;
            --card:#0b1220;
            --accent:#ff6b6b;
            --muted:#9aa4b2;
            --glass: rgba(255,255,255,0.04);
        }
        *{box-sizing:border-box;margin:0;padding:0}
        html,body{height:100%;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Helvetica Neue",Arial; background: linear-gradient(180deg,#071026 0%, #071833 60%); color:#e6eef8; -webkit-font-smoothing:antialiased}
        .wrap{max-width:760px;margin:20px auto;padding:16px;width:calc(100% - 32px)}
        .player-card{background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02)); border-radius:16px; padding:16px; box-shadow:0 6px 30px rgba(2,6,23,0.6); display:flex; flex-direction:column; gap:12px}
        .top{display:flex;gap:12px;align-items:center}
        .cover{width:84px;height:84px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#6b8cff);flex:0 0 84px;display:flex;align-items:center;justify-content:center;font-weight:700;color:rgba(255,255,255,0.95)}
        .meta{flex:1;min-width:0}
        .title{font-size:16px;font-weight:600;color:#fff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .artist{font-size:13px;color:var(--muted);margin-top:6px}

        .progress-wrap{padding:6px 0}
        .progress-bar{height:6px;background:var(--glass);border-radius:999px;position:relative;overflow:hidden;touch-action:none}
        .progress-buffer{position:absolute;left:0;top:0;height:100%;background:rgba(255,255,255,0.06);width:0}
        .progress-fill{position:absolute;left:0;top:0;height:100%;background:linear-gradient(90deg,var(--accent),#6b8cff);width:0}
        .time{display:flex;justify-content:space-between;font-size:12px;color:var(--muted);margin-top:8px}

        .controls{display:flex;gap:18px;align-items:center;justify-content:center;padding:6px}
        .btn{background:transparent;border:none;color:inherit;display:inline-flex;align-items:center;justify-content:center;cursor:pointer}
        .big-btn{width:64px;height:64px;border-radius:50%;background:linear-gradient(180deg,rgba(255,255,255,0.06), rgba(255,255,255,0.03));box-shadow:0 6px 18px rgba(11,20,32,0.6);font-size:20px}

        .search-box{margin-top:6px}
        .search-input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;font-size:14px}

        .playlist{max-height:260px;overflow:auto;margin-top:8px;border-radius:8px;padding:8px;background:transparent}
        .song-item{padding:10px 12px;border-radius:8px;color:var(--muted);font-size:14px;display:flex;justify-content:space-between;align-items:center;gap:8px}
        .song-item + .song-item{margin-top:6px}
        .song-item.active{background:linear-gradient(90deg, rgba(255,107,107,0.08), rgba(107,140,255,0.06));color:#fff}
        .no-result{Padding:12px;text-align:center;color:var(--muted)}

        @media(min-width:720px){.wrap{padding:24px}.player-card{padding:20px}}
        @media(max-width:420px){.cover{width:72px;height:72px}.big-btn{width:56px;height:56px}}
    </style>
</head>
<body>
    <div class="wrap">
        <div class="player-card">
            <div class="top">
                <div class="cover" id="cover">歌</div>
                <div class="meta">
                    <div class="title" id="songTitle">未播放歌曲</div>
                    <div class="artist" id="artist">未知艺术家</div>
                </div>
            </div>

            <div class="progress-wrap">
                <div class="progress-bar" id="progressBar">
                    <div class="progress-buffer" id="progressBuffer"></div>
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="time"><span id="currentTime">00:00</span><span id="totalTime">00:00</span></div>
            </div>

            <div class="controls">
                <button class="btn" id="prevBtn" aria-label="上一首">
                    <!-- previous icon -->
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                        <path d="M6 6h2v12H6V6zm3.5 6l8.5 6V6l-8.5 6z" fill" fill="currentColor"/>
                    </svg>
                </button>
                <button class="btn big-btn" id="playBtn" aria-label="播放/暂停">▶</button>
                <button class="btn" id="nextBtn" aria-label="下一首">
                    <!-- next icon -->
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                        <path d="M6 6l8.5 6-8.5 6V6zm11 0h2v12h-2V6z" fill="currentColor"/>
                    </svg>
                </button>
            </div>

            <div class="search-box"><input id="searchInput" class="search-input" placeholder="搜索歌曲..."/></div>

            <div class="playlist" id="playlist">
                <div class="song-item">加载中...</div>
            </div>
        </div>
    </div>

    <script>
        const audio = new Audio();
        const playBtn = document.getElementById('playBtn');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const progressBar = document.getElementById('progressBar');
        const progressBuffer = document.getElementById('progressBuffer');
        const progressFill = document.getElementById('progressFill');
        const currentTimeEl = document.getElementById('currentTime');
        const totalTimeEl = document.getElementById('totalTime');
        const songTitleEl = document.getElementById('songTitle');
        const playlistEl = document.getElementById('playlist');
        const searchInput = document.getElementById('searchInput');
        const coverEl = document.getElementById('cover');
        const artistEl = document.getElementById('artist');

        let songList = [];
        let filteredList = [];
        let currentIndex = 0;
        let isPlaying = false;
        let bufferTimer = null;

        async function loadSongs() {
            try {
                const res = await fetch('https://cdn.jsdelivr.net/gh/nj-lizhi/song/audio/download.txt');
                if (!res.ok) throw new Error('加载失败');

                const text = await res.text();
                songList = text.split('\n')
                    .filter(line => line.trim() && (line.endsWith('.mp3') || line.endsWith('.flac')))
                    .map(url => {
                        const newUrl = url.replace('testingcf.jsdelivr.net', 'cdn.jsdmirror.com');
                        const fileName = newUrl.split('/').pop();
                        const title = fileName.substring(0, fileName.lastIndexOf('.'));
                        return { title, url: newUrl };
                    });

                filteredList = [...songList];
                renderPlaylist();
                initSearch();
            } catch (err) {
                playlistEl.innerHTML = `<div class="song-item">${err.message}</div>`;
            }
        }

        function renderPlaylist() {
            playlistEl.innerHTML = '';
            if (filteredList.length === 0) {
                const noResult = document.createElement('div');
                noResult.className = 'no-result';
                noResult.textContent = '未找到匹配歌曲';
                playlistEl.appendChild(noResult);
                return;
            }

            filteredList.forEach((song) => {
                const originalIndex = songList.findIndex(item => item.url === song.url);
                const item = document.createElement('div');
                item.className = 'song-item';
                item.dataset.index = originalIndex;
                const titleSpan = document.createElement('span');
                titleSpan.textContent = song.title;
                item.appendChild(titleSpan);
                item.onclick = () => {
                    currentIndex = originalIndex;
                    isPlaying = true;
                    playSong();
                    scrollToActiveSong();
                };
                playlistEl.appendChild(item);
            });

            updatePlaylistActive();
        }

        function updatePlaylistActive() {
            document.querySelectorAll('.song-item').forEach(item => {
                if (Number(item.dataset.index) === currentIndex) item.classList.add('active');
                else item.classList.remove('active');
            });
        }

        function initSearch() {
            searchInput.addEventListener('input', (e) => {
                const keyword = e.target.value.trim().toLowerCase();
                filteredList = songList.filter(song => song.title.toLowerCase().includes(keyword));
                renderPlaylist();
            });
        }

        function playSong() {
            if (!songList.length) return;
            const song = songList[currentIndex];
            audio.pause();
            audio.preload = 'auto';
            audio.src = song.url;
            songTitleEl.textContent = song.title;
            artistEl.textContent = '李志';
            // cover: show first 2 chars as fallback
            coverEl.textContent = song.title.slice(0,2).toUpperCase();

            updatePlaylistActive();

            audio.onloadedmetadata = () => {
                // update buffered UI once metadata is available
                updateBuffer();
                if (bufferTimer) clearInterval(bufferTimer);
                bufferTimer = setInterval(updateBuffer, 700);
                audio.play().then(() => {
                    isPlaying = true;
                    playBtn.textContent = '❚❚';
                }).catch(() => {
                    isPlaying = false;
                    playBtn.textContent = '▶';
                });
            };
        }

        playBtn.onclick = () => {
            if (!songList.length) {
                loadSongs().then(() => {
                    if (songList.length) {
                        isPlaying = true;
                        playSong();
                    }
                });
                return;
            }

            if (isPlaying) {
                audio.pause();
                playBtn.textContent = '▶';
            } else {
                audio.play().then(()=>{
                    playBtn.textContent = '❚❚';
                }).catch(()=>{
                    playBtn.textContent = '▶';
                });
            }
            isPlaying = !isPlaying;
        };

        prevBtn.onclick = () => {
            if (!songList.length) return;
            currentIndex = (currentIndex - 1 + songList.length) % songList.length;
            isPlaying = true;
            playSong();
            scrollToActiveSong();
        };

        nextBtn.onclick = () => {
            if (!songList.length) return;
            currentIndex = (currentIndex + 1) % songList.length;
            isPlaying = true;
            playSong();
            scrollToActiveSong();
        };

        function scrollToActiveSong() {
            const activeItem = document.querySelector('.song-item.active');
            if (activeItem) activeItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        audio.ontimeupdate = () => {
            if (isNaN(audio.duration)) return;
            const progress = (audio.currentTime / audio.duration) * 100;
            progressFill.style.width = `${progress}%`;
            currentTimeEl.textContent = formatTime(audio.currentTime);
            totalTimeEl.textContent = formatTime(audio.duration);
        };

        // update buffered progress using audio.buffered ranges
        function updateBuffer(){
            try{
                if (isNaN(audio.duration) || !audio.buffered) {
                    progressBuffer.style.width = `0%`;
                    return;
                }
                // find the last buffered range that starts at or before currentTime
                let bufferedEnd = 0;
                for (let i=0;i<audio.buffered.length;i++){
                    bufferedEnd = Math.max(bufferedEnd, audio.buffered.end(i));
                }
                const bufPercent = Math.min(100, (bufferedEnd / audio.duration) * 100);
                progressBuffer.style.width = `${bufPercent}%`;
            }catch(e){
                // ignore
            }
        }

        audio.addEventListener('progress', updateBuffer);
        audio.addEventListener('waiting', ()=>{
            // network stall - show buffering indicator
            playBtn.textContent = '⏳';
        });
        audio.addEventListener('stalled', ()=>{
            playBtn.textContent = '⏳';
        });
        audio.addEventListener('playing', ()=>{
            // restore play icon when actually playing
            if (isPlaying) playBtn.textContent = '❚❚';
            updateBuffer();
        });
        audio.addEventListener('canplay', ()=>{
            updateBuffer();
        });
        // clear interval on unload
        window.addEventListener('beforeunload', ()=>{ if (bufferTimer) clearInterval(bufferTimer); });

        // Pointer-based seek for better mobile support
        let dragging = false;
        function seekFromClientX(clientX){
            const rect = progressBar.getBoundingClientRect();
            let pos = (clientX - rect.left) / rect.width;
            pos = Math.max(0, Math.min(1, pos));
            if (!isNaN(audio.duration)) audio.currentTime = pos * audio.duration;
        }

        progressBar.addEventListener('pointerdown', (e) => {
            dragging = true;
            progressBar.setPointerCapture(e.pointerId);
            seekFromClientX(e.clientX);
        });
        progressBar.addEventListener('pointermove', (e) => {
            if (!dragging) return;
            seekFromClientX(e.clientX);
        });
        progressBar.addEventListener('pointerup', (e) => {
            dragging = false;
            try { progressBar.releasePointerCapture(e.pointerId); } catch(_){}
        });

        function formatTime(sec) {
            const m = Math.floor(sec / 60).toString().padStart(2, '0');
            const s = Math.floor(sec % 60).toString().padStart(2, '0');
            return `${m}:${s}`;
        }

        audio.onended = () => nextBtn.click();

        // 初始化加载歌曲列表
        loadSongs();
    </script>
</body>
</html>
